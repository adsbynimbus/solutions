name: Build and Analyze

on:
  pull_request:
  push:
    branches:
      - main
  schedule:
    - cron: '55 23 * * 6'

permissions:
  actions: read
  contents: write
  packages: read
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  XCODE_VERSION: '26.2'

jobs:
  actions:
    runs-on: ubuntu-slim
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Analyze
        uses: ./.github/actions/codeql
        with:
          language: actions

  gradle:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Setup Gradle
        uses: ./.github/actions/gradle
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
      - name: Analyze
        uses: ./.github/actions/codeql
        with:
          language: java-kotlin
          command: ./gradlew assemble --init-script gradle/codeql.init.gradle.kts
      - name: Build
        run: ./gradlew build
      - name: Upload build reports
        uses: actions/upload-artifact@v6
        if: ${{ !cancelled() }}
        with:
          name: gradle-reports
          path: '**/build/reports/'

  xcodebuild:
    runs-on: macos-26
    timeout-minutes: 20
    env:
      NSUnbufferedIO: YES
      SWIFTPM_MAX_CONCURRENT_OPERATIONS: 1
    steps:
      - name: Checkout sources
        uses: actions/checkout@v6
      - name: Setup Xcode
        id: xcodebuild
        uses: ./.github/actions/xcodebuild
      - name: Restore Compilation Cache
        uses: actions/cache/restore@v5
        if: ${{ github.ref != 'refs/heads/main' }}
        with:
          path: ~/Library/Developer/Xcode/DerivedData/CompilationCache.noindex
          key: ${{ runner.os }}-xcodebuild-${{ env.XCODE_VERSION }}-${{ hashFiles('**/*.xc*') }}
          restore-keys: |
            ${{ runner.os }}-xcodebuild-${{ env.XCODE_VERSION }}-
      - name: Analyze
        uses: ./.github/actions/codeql
        with:
          language: swift
          command: xcodebuild build ${{ steps.xcodebuild.outputs.options }}
      - name: Test
        run: xcodebuild test ${{ steps.xcodebuild.outputs.options }}
      - name: Upload build reports
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: xcodebuild-reports
          path: '~/Library/Developer/Xcode/DerivedData/**/Logs/'
      - name: Save Compilation Cache
        uses: actions/cache/save@v5
        if: ${{ github.ref == 'refs/heads/main' }}
        with:
          path: ~/Library/Developer/Xcode/DerivedData/CompilationCache.noindex
          key: ${{ steps.restore-cache.outputs.cache-primary-key }}

